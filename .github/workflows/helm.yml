name: Helm Only Deployment

on:
  workflow_dispatch:
    inputs:
      master_ip:
        description: 'Kubernetes Master IP (public)'
        required: true
        type: string

env:
  DOCKER_IMAGE: basilm95/jewelry-shop
  AWS_REGION: us-east-1

jobs:
  helm:
    name: Helm Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/labsuser.pem
          chmod 600 ~/.ssh/labsuser.pem

      - name: Get NFS server IP (master private IP)
        id: nfs_ip
        run: |
          NFS_IP=$(ssh -i ~/.ssh/labsuser.pem -o StrictHostKeyChecking=no \
            ubuntu@${{ github.event.inputs.master_ip }} \
            "hostname -I | awk '{print \$1}'")
          echo "ip=$NFS_IP" >> $GITHUB_OUTPUT
          echo "NFS Server IP: $NFS_IP"

      - name: Verify cluster connectivity
        run: |
          ssh -i ~/.ssh/labsuser.pem -o StrictHostKeyChecking=no \
            ubuntu@${{ github.event.inputs.master_ip }} \
            "kubectl get nodes"

      - name: Copy Helm chart to master
        run: |
          scp -i ~/.ssh/labsuser.pem -o StrictHostKeyChecking=no -r \
            helm-charts/jewelry-shop \
            ubuntu@${{ github.event.inputs.master_ip }}:~/

      - name: Deploy with Helm
        run: |
          ssh -i ~/.ssh/labsuser.pem \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=3 \
            -o TCPKeepAlive=yes \
            ubuntu@${{ github.event.inputs.master_ip }} \
            "helm upgrade --install jewelry-shop ~/jewelry-shop \
              --set image.repository=${{ env.DOCKER_IMAGE }} \
              --set image.tag=latest \
              --set persistence.nfsServer=${{ steps.nfs_ip.outputs.ip }} \
              --timeout 10m \
              --debug 2>&1 | tee helm-deploy.log; exit \${PIPESTATUS[0]}"

      - name: Check deployment status
        if: failure()
        run: |
          echo "Helm deployment failed. Checking logs..."
          ssh -i ~/.ssh/labsuser.pem -o StrictHostKeyChecking=no \
            ubuntu@${{ github.event.inputs.master_ip }} \
            "cat helm-deploy.log || echo 'No log file found'"

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/labsuser.pem -o StrictHostKeyChecking=no \
            ubuntu@${{ github.event.inputs.master_ip }} \
            "kubectl get pods -n default && kubectl get svc -n default"

      - name: Wait for pods to be ready
        run: |
          ssh -i ~/.ssh/labsuser.pem -o StrictHostKeyChecking=no \
            ubuntu@${{ github.event.inputs.master_ip }} \
            "kubectl wait --for=condition=ready pod -l app=jewelry-shop --timeout=5m"

      - name: Get service details
        run: |
          ssh -i ~/.ssh/labsuser.pem -o StrictHostKeyChecking=no \
            ubuntu@${{ github.event.inputs.master_ip }} \
            "kubectl get svc jewelry-shop -o wide && echo '---' && kubectl describe svc jewelry-shop"
